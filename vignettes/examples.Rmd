---
title: "Introduction to the aire.zmvm package"
author: "Diego Valle-Jones"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Figures

The figure sizes have been customised so that you can easily put two images side-by-side. 

get_zone_data

```{r, fig.show='hold',  message=FALSE}
library("aire.zmvm")
library("dplyr")
library("ggplot2")

# Download pm10 data since 2008 for all available zones ("TZ")
pm_10 <- get_zone_data(criterion = "MAXIMOS", # Can be MAXIMOS (daily maximum) or HORARIOS (hourly average)
                       pollutant = "PM10", # "SO2", "CO", "NO2", "O3", "PM10", "TC" (All pollutants)
                       zone = "TZ", # "NO", "NE", "CE", "SO", "SE", "TZ" (All zones)
                       start_date = "2008-01-01", # Can't be earlier than 2008-01-01
                       end_date = "2016-03-19") # Can be up to the current date
knitr::kable(head(pm_10))

# Plot the overall highest maximum pm10 level with trendline
ggplot(pm_10 %>% group_by(date) %>% summarise(max = max(value, na.rm = TRUE)), 
       aes(date, max, group = 1)) +
  geom_line(color = "darkgray", size = .2) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 50), se = FALSE) +
  ggtitle("Daily maximum PM10 levels in IMECAS") +
  theme_bw()

```

get_station_data

```{r, fig.show='hold',  message=FALSE}
o3 <- get_station_data(criterion = "MAXIMOS", # Can be MAXIMOS (daily maximum), MINIMOS (daily minimum), or HORARIOS (hourly average)
                       pollutant = "O3", # "so2", "co", "nox", "no2",
                             # "no", "o3", "pm10", "pm2",
                             # "wsp", "wdr", "tmp", "rh"
                       year = 2008:2016) # The earliest available year is 2005 

knitr::kable(head(o3))

# Plot the overall highest maximum ozone level with trendline
ggplot(o3 %>% group_by(date) %>% summarise(max = max(value, na.rm = TRUE)), 
       aes(date, max, group = 1)) +
  geom_line(color = "darkgray", size = .2) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 10), se = FALSE) +
  ggtitle("Daily maximum ozone levels in ppb") +
  theme_bw()
```

```{r}
library("seasonal")
library("lubridate")



pm10_stations <- get_station_data("MAXIMOS", "PM10", 2008:2016)




# Monthly median of maximums
pm10_m <- pm10_stations %>%
  group_by(date) %>%
  summarise(max = max(value, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(month(date), year(date)) %>%
  summarise(max = max(max))


pm10_ts <- ts(pm10_m$max, start = 2008, freq = 12)

# #Seasonally adjusted (by trading day and easter holiday)
m <- seas(pm10_ts,
          regression.variables = c("td1coef", "easter[1]"))
plot(m) 
```

available stations

```{r}
data("stations")
knitr::kable(head(stations))

library("ggmap")
library("viridis")
library("gstat")
library("sp")

qmplot(lon, lat, data = stations, maptype = "toner-background")

o3_stations <- get_station_data("MAXIMOS", "O3", 2016)
phase_i <- filter(o3_stations, date == "2016-03-14") %>%
  left_join(stations)
phase_i <- na.omit(phase_i)

qmplot(lon, lat, data = na.omit(phase_i), maptype = "toner-background" ) +
  geom_point(aes(color = value), size = 8) +
  scale_color_viridis()

geog.o3 <- phase_i[,c("lat", "lon", "value")]
coordinates(geog.o3) <- ~lon+lat
spplot(geog.o3)

pixels = 50
geog.grd <- expand.grid(x=seq((min(coordinates(geog.o3)[,1])-.2),
                          (max(coordinates(geog.o3)[,1])+.2),
                          length.out=pixels),
                        y=seq((min(coordinates(geog.o3)[,2])-.2),
                          (max(coordinates(geog.o3)[,2])+.2),
                          length.out=pixels))

grd.pts <- SpatialPixels(SpatialPoints((geog.grd)))
grd.pts <- as(grd.pts, "SpatialGrid")
plot(grd.pts, cex = 1.5, col = "grey")
points(geog.o3, pch = 1, col = "red", cex = 1)

geog.idw <- idw(value ~ 1, geog.o3, grd.pts, idp=6)

spplot(geog.idw["var1.pred"])

idw = as.data.frame(geog.idw)
names(idw) <- c("var1.pred", "var1.var", "lon", "lat") 

qmplot(x, y, data = geog.grd, geom = "blank", 
       maptype = "terrain", source = "google")  +
  geom_tile(data = idw, aes(x = lon, y = lat, fill = var1.pred), alpha = .5) + 
  scale_fill_viridis("Ozone levels\n(ppb)") +
  geom_point(data = phase_i, aes(x = lon, y = lat), shape = 21, 
             colour = "black") +
  ggtitle("Peak Ozone levels during the Phase I alert in Mexico City")

```
